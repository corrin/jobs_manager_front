name: Frontend CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Frontend to EC2
    runs-on: ubuntu-latest

    steps:
      # Code Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4

      # AWS Configuration
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Deploy to Frontend Machine
        env:
          FRONTEND_INSTANCE_ID: ${{ vars.FRONTEND_INSTANCE_ID }}
          PROJECT_PATH: ${{ vars.FRONTEND_PROJECT_PATH }}
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: |
          echo "Deploying to Frontend Machine: $FRONTEND_INSTANCE_ID"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids $FRONTEND_INSTANCE_ID \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=['sudo su - ubuntu -c \"$PROJECT_PATH/scripts/deploy_frontend.sh\"']" \
            --region $AWS_REGION \
            --query 'Command.CommandId' \
            --output text)

          echo "Command ID: $COMMAND_ID"

          # Wait for command to reach a terminal state so we can still capture logs even on failure
          STATUS="Pending"
          ATTEMPT=0
          MAX_ATTEMPTS=120 # ~10 minutes with 5s interval
          SLEEP_SECONDS=5

          set +e
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            POLL_OUTPUT=$(aws ssm get-command-invocation \
              --command-id $COMMAND_ID \
              --instance-id $FRONTEND_INSTANCE_ID \
              --region $AWS_REGION \
              --query 'Status' \
              --output text 2>&1)

            if [ $? -ne 0 ]; then
              if echo "$POLL_OUTPUT" | grep -qi "InvocationDoesNotExist"; then
                STATUS="Pending"
              else
                echo "Failed to poll SSM command status: $POLL_OUTPUT"
                exit 1
              fi
            else
              STATUS="$POLL_OUTPUT"
            fi

            echo "Command status: $STATUS"

            case "$STATUS" in
              Pending|InProgress|Delayed)
                sleep $SLEEP_SECONDS
                ;;
              Success|Failed|TimedOut|Cancelled|Cancelling|Undeliverable)
                break
                ;;
              *)
                sleep $SLEEP_SECONDS
                ;;
            esac

            ATTEMPT=$((ATTEMPT + 1))
          done
          set -e

          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
            echo "Timed out waiting for SSM command to finish after $((MAX_ATTEMPTS * SLEEP_SECONDS)) seconds"
          fi

          # Get command output
          STATUS=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id $FRONTEND_INSTANCE_ID \
            --region $AWS_REGION \
            --query 'Status' \
            --output text)

          OUTPUT=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id $FRONTEND_INSTANCE_ID \
            --region $AWS_REGION \
            --query 'StandardOutputContent' \
            --output text)

          ERROR_OUTPUT=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id $FRONTEND_INSTANCE_ID \
            --region $AWS_REGION \
            --query 'StandardErrorContent' \
            --output text)

          echo "Status: $STATUS"
          echo "Output: $OUTPUT"
          if [ "$ERROR_OUTPUT" != "None" ] && [ "$ERROR_OUTPUT" != "" ]; then
            echo "Error Output: $ERROR_OUTPUT"
          fi

          if [ "$STATUS" != "Success" ]; then
            echo "Frontend deployment failed"
            exit 1
          else
            echo "âœ… Frontend deployment successful"
          fi
